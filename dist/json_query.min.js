!function(window){"use strict";var JsonQuery=function(records,opts){return new _JsonQuery(records,opts||{})};window.JsonQuery=JsonQuery,JsonQuery.VERSION="0.0.2",Object.defineProperty||(Object.defineProperty=function(obj,name,opts){obj[name]=opts.get});var each=function(objs,callback,context){if(objs.length===+objs.length)for(var i=0,l=objs.length;l>i;i++)callback.call(context,objs[i],i);else for(var key in objs)hasOwnProperty.call(objs,key)&&callback.call(context,objs[key],key)},eachWithBreak=function(objs,callback,context){for(var i=0,l=objs.length;l>i;i++)if(callback.call(context,objs[i],i)===!1)return},_JsonQuery=function(records,opts){this.records=records||[],this.getterFns=opts.getterFns||{},this.lat=opts.latitude||"latitude",this.lng=opts.longitude||"longitude",this.id=opts.id,this.records.length&&initSchema(this,records[0])},JQ=_JsonQuery.prototype,initSchema=function(context,record){context.schema={},context.id||(context.id=record._id?"_id":"id"),buildSchema.call(context,record),buildPropGetters.call(context,record)},getDataType=function(val){if(null==val)return"String";var type=Object.prototype.toString.call(val).slice(8,-1);return"String"==type&&val.match(/\d{4}-\d{2}-\d{2}/)?"Date":type},buildSchema=function(obj,parentField){var field,dataType,fullPath,fieldValue;for(field in obj)fieldValue=obj[field],dataType=getDataType(fieldValue),fullPath=parentField?parentField+"."+field:field,this.schema[fullPath]=dataType,"Object"==dataType?buildSchema.call(this,fieldValue,fullPath):"Array"==dataType&&(["Object","Array"].indexOf(getDataType(fieldValue[0]))>-1?buildSchema.call(this,obj[field][0],fullPath):this.schema[fullPath]=getDataType(fieldValue[0]))},buildPropGetters=function(record){var selector,type,val;for(selector in this.schema){type=this.schema[selector];try{this.getterFns[selector]||(this.getterFns[selector]=buildGetPropFn.call(this,selector,type)),val=this.getterFns[selector](record),"Array"==getDataType(val)&&(this.schema[selector]="Array")}catch(err){console.log("Error while generating getter function for selector : "+selector+" NOTE: Define manually")}}},countArrHierarchy=function(schema,nestedPath){for(var path,lastArr=0,arrCount=0,pathLength=nestedPath.length-1,i=nestedPath.length-1;i>=0;i--)path=nestedPath.slice(0,i+1).join("."),"Array"==schema[path]&&pathLength>i&&(lastArr=i,arrCount+=1);return arrCount>1?lastArr+1:-1},buildGetPropFn=function(field){for(var path,prefix,accessFnBody,accessPath="",nestedPath=field.split("."),lastArr=countArrHierarchy(this.schema,nestedPath),i=nestedPath.length-1;i>=0;i--)path=nestedPath.slice(0,i+1).join("."),prefix="['"+nestedPath[i]+"']",accessPath="Array"==this.schema[path]?lastArr==i?prefix+(accessPath.length?".map(function(r"+i+"){  objs.push(r"+i+accessPath+")})":""):prefix+(accessPath.length?".map(function(r"+i+"){  return r"+i+accessPath+"})":""):prefix+accessPath;return accessFnBody=lastArr>-1?"var objs = []; obj"+accessPath+";"+("Date"==this.schema.path?"return parseDate(objs)":"return objs;"):"return "+("Date"==this.schema.path?"parseDate(obj"+accessPath+");":"obj"+accessPath+";"),new Function("obj",accessFnBody)};JQ.operators={eq:function(v1,v2){return v1==v2},ne:function(v1,v2){return v1!=v2},lt:function(v1,v2){return v2>v1},lte:function(v1,v2){return v2>=v1},gt:function(v1,v2){return v1>v2},gte:function(v1,v2){return v1>=v2},"in":function(v1,v2){return v2.indexOf(v1)>-1},ni:function(v1,v2){return-1==v2.indexOf(v1)},li:function(v,regx){return regx.test(v)},bt:function(v1,v2){return v1>=v2[0]&&v1<=v2[1]}},JQ.addOperator=function(name,fn){this.operators[name]=fn};var arrayMatcher=function(rVal,cVal,cFn){var i=0,l=rVal.length;for(i;l>i;i++)if(cFn(rVal[i],cVal))return!0};JQ.addCondition=function(name,func){this.operators[name]=func},JQ.getCriteria=function(criteria){var fieldCondition=criteria.split(".$");return{field:fieldCondition[0],operator:fieldCondition[1]||"eq"}},JQ.setGetterFn=function(field,fn){this.getterFns[field]=fn},JQ.addRecords=function(records){return records&&records.length?("Array"==getDataType(records)?this.records=this.records.concat(records):this.records.push(records),this.schema||initSchema(this,records[0]),!0):!1},JQ._findAll=function(records,qField,cVal,cOpt){var cFn,rVal,arrayCFn,result=[],qFn=this.getterFns[qField];return"li"==cOpt&&"string"==typeof cVal&&(cVal=new RegExp(cVal)),cFn=this.operators[cOpt],"Array"==this.schema[qField]&&(arrayCFn=cFn,cFn=arrayMatcher),each(records,function(v){rVal=qFn(v),cFn(rVal,cVal,arrayCFn)&&result.push(v)}),result},JQ.find=function(field,value){var result,qFn;return value||(value=field,field=this.id),qFn=this.getterFns[field],eachWithBreak(this.records,function(r){return qFn(r)==value?(result=r,!1):void 0}),result},each(["where","or","groupBy","select","pluck","limit","offset","order","uniq","near"],function(c){JQ[c]=function(){var q=new Query(this,this.records);return q[c].apply(q,arguments),q}}),each(["count","first","last","all"],function(c){Object.defineProperty(JQ,c,{get:function(){return new Query(this,this.records)[c]}})});var compareObj=function(obj1,obj2,fields){for(var i=0,l=fields.length;l>i;i++)if(this.getterFns[fields[i]](obj1)!==this.getterFns[fields[i]](obj2))return!1;return!0},execWhere=function(query,records){var q,criteria,result;for(q in query)criteria=this.jQ.getCriteria(q),result=this.jQ._findAll(result||records,criteria.field,query[q],criteria.operator);return result},execGroupBy=function(field,records){{var v,fn=this.jQ.getterFns[field],result={};records.length}return each(records,function(r){v=fn(r),(result[v]||(result[v]=[])).push(r)}),result},execOrder=function(orders,records){for(var fn,direction,_records=records.slice(0),i=0,l=orders.length;l>i;i++)fn=this.jQ.getterFns[orders[i].field],direction="asc"==orders[i].direction?1:-1,_records.sort(function(r1,r2){var a=fn(r1),b=fn(r2);return(b>a?-1:a>b?1:0)*direction});return _records},execSelect=function(fields,records){var getFn,self=this,result=[];return each(fields,function(f){getFn=self.jQ.getterFns[f],each(records,function(r,i){(result[i]||(result[i]={}))[f]=getFn(r)})}),result},execPluck=function(field,records){var getFn=this.jQ.getterFns[field],result=[];return each(records,function(r){result.push(getFn(r))}),result},execUniq=function(fields,records){var result=[],self=this;return"Object"!=getDataType(records[0])?(each(records,function(r){-1==result.indexOf(r)&&result.push(r)}),result):(result.push(records[0]),each(records,function(r){for(var present=!1,i=0,l=result.length;l>i;i++)compareObj.call(self.jQ,result[i],r,fields)&&(present=!0);present||result.push(r)}),result)},Query=function(jQ,records){return this.jQ=jQ,this.records=records,this.criteria={},this},Q=Query.prototype;Q.each=function(callback,context){each(this.exec()||[],callback,context)},Q.exec=Q.toArray=function(callback){var result;return this.criteria.all&&(result=this.records),this.criteria.where&&(result=execWhere.call(this,this.criteria.where,result||this.records)),this.criteria.or&&(result=result.concat(execWhere.call(this,this.criteria.or,this.records)),result=execUniq.call(this,[this.jQ.id],result)),this.criteria.order&&(result=execOrder.call(this,this.criteria.order,result||this.records)),this.criteria.near&&(result=execNear.call(this,this.criteria.near,result||this.records)),this.criteria.uniq&&(result=execUniq.call(this,this.criteria.uniq,result||this.records)),this.criteria.select&&(result=execSelect.call(this,this.criteria.select,result||this.records)),this.criteria.pluck&&(result=execPluck.call(this,this.criteria.pluck,result||this.records)),this.criteria.limit&&(result=(result||this.records).slice(this.criteria.offset||0,(this.criteria.offset||0)+this.criteria.limit)),this.criteria.group_by&&(result=execGroupBy.call(this,this.criteria.group_by,result||this.records)),callback&&each(result||this.records,callback),result||(result=this.records),this.jQ.onResult&&this.jQ.onResult(result,this.criteria),result};var addToCriteria=function(type,query){var c;this.criteria[type]||(this.criteria[type]={});for(c in query)this.criteria[type][c]=query[c];return this};Q.where=function(query){return addToCriteria.call(this,"where",query)},Q.or=function(query){return addToCriteria.call(this,"or",query)},Q.groupBy=function(field){return this.criteria.group_by=field,this},Q.select=function(){return this.criteria.select=arguments,this},Q.pluck=function(field){return this.criteria.pluck=field,this},Q.limit=function(l){return this.criteria.limit=l,this},Q.offset=function(o){return this.criteria.offset=o,this},Q.order=function(criteria){var field;this.criteria.order=this.criteria.order||[];for(field in criteria)this.criteria.order.push({field:field,direction:criteria[field].toLowerCase()});return this},Q.uniq=function(){return this.criteria.uniq=arguments.length>0?arguments:!0,this},Object.defineProperty(Q,"count",{get:function(){this.criteria.count=!0;var r=this.exec();return"Array"==getDataType(r)?this.exec().length:Object.keys(r).length}}),Object.defineProperty(Q,"all",{get:function(){return this.criteria.all=!0,this.exec()}}),Object.defineProperty(Q,"first",{get:function(){return this.criteria.first=!0,this.exec()[0]}}),Object.defineProperty(Q,"last",{get:function(){this.criteria.last=!0;var r=this.exec();return r[r.length-1]}});var GEO={redius:6371,toRad:function(v){return v*Math.PI/180}},calculateDistance=function(lat1,lat2,lng1,lng2){var dLat=GEO.toRad(lat2-lat1),dLon=GEO.toRad(lng2-lng1),lat1=GEO.toRad(lat1),lat2=GEO.toRad(lat2),a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.sin(dLon/2)*Math.sin(dLon/2)*Math.cos(lat1)*Math.cos(lat2);return 2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))*GEO.redius},execNear=function(opts,records){var result=[],self=this,unit_c="mile"==opts.unit?.6214:1,latFn=self.jQ.getterFns[self.jQ.lat],lngFn=self.jQ.getterFns[self.jQ.lng];return each(records,function(r){r._distance=calculateDistance(latFn(r),opts.lat,lngFn(r),opts.lng)*unit_c,r._distance<=opts.distance&&result.push(r)}),result.sort(function(a,b){return a._distance<b._distance?-1:a._distance>b._distance?1:0}),result};Q.near=function(lat,lng,distance,unit){return this.criteria.near={lat:lat,lng:lng,distance:distance,unit:unit||"km"},this},Q.map=Q.collect=function(fn){var out,result=[];return this.exec(function(r){(out=fn(r))&&result.push(out)}),result},Q.sum=function(field){var group,result=0,getFn=this.jQ.getterFns[field];return this.criteria.group_by&&(group=!0,result={}),this.exec(function(r,i){group?(result[i]=0,each(r,function(e){result[i]=result[i]+(getFn(e)||0)})):result+=getFn(r)||0}),result}}(this),Array.prototype.indexOf||(Array.prototype.indexOf=function(obj,start){for(var i=start||0,j=this.length;j>i;i++)if(this[i]===obj)return i;return-1});